= 设计过程

本文简单记录笔者实现过程中的一些思路。

== 实体类关联分析

=== 实体类转实体表信息

以下演示转换 `UserSelfReference` 实体类为实体表信息：

.User
[source%nowrap,java]
----
package com.github.peacetrue.sample.User;
@Entity(name="用户") //<1>
public class User {
    @Property(name="主键") //<2>
    private Long id;
    @Property(name="用户名") //<2>
    private String name;
    @Property(name="昵称") //<2>
    private String nickname;
}
----
<1> 用于配置实体名称
<2> 用于配置属性名称

.实体表信息
|===
|主键 |编码 |名称 |多对多 |备注 |序号

|1
|com.github.peacetrue.sample.User
|用户
|否
|
|1
|===

* 编码使用全限定类名
* 名称通过注解获取，若无注解使用简单名称即 `UserSelfReference`

.Java 基础类型
|===
|主键 |编码 |名称

|1
|java.lang.Long
|长整型

|1
|java.lang.Integer
|整型

|1
|java.lang.Short
|短整型

|1
|java.lang.Byte
|字节

|1
|java.lang.Float
|单精度浮点型

|1
|java.lang.Double
|双精度浮点型

|1
|java.lang.String
|字符串

|1
|java.lang.Boolean
|布尔型

|1
|java.util.Date
|日期

|1
|java.time.LocalDate
|本地日期

|1
|java.time.LocalDateTime
|本地日期时间
|===

* 编码使用全限定类名

.属性表
|===
|主键 |编码 |名称 |类型 |关联实体 |备注 |序号

|1
|id
|主键
|Long
|
|
|1

|1
|name
|用户名
|String
|
|
|2

|1
|nickname
|昵称
|String
|
|
|3
|===

* 名称通过注解获取，若无注解使用编码
* 类型实际使用主键，上面用编码直观表示

=== 实体对象转记录表信息

以下演示转换实体对象 `new User(1L,"admin","管理员")` 为记录表信息：

.记录表信息
|===
|主键 |所属实体

|1
|用户
|===

.属性值表信息
|===
|主键 |所属记录 |关联属性 |属性值

|1
|
|id
|1

|2
|1
|name
|admin

|3
|1
|nickname
|管理员
|===

.实现步骤
. 启动系统
. 扫描实体类
. 实体类转换为【实体记录、属性记录】，额外保存实体类到实体记录的关联。

=== 一对一/一对多

.用户
|===
|主键 |用户名 | 昵称    | 引用次数

|1 |zhangsan | 张三   | 1
|2 |lisi     | 李四   | 1
|===

用户(1) 引用次数 1 源于登陆记录(1)； 用户(2) 引用次数 1 源于登陆记录(2)；

.登陆记录
|===
|主键 |用户主键 | 登陆时间

|1    |1      | 2020-01-01 01:01:01
|2    |2      | 2020-01-01 01:01:01
|===

=== 多对多

.角色
|===
|主键 |编码 | 名称

|1 |admin | 管理员
|2 |normal | 普通用户
|===

在引用计数算法中，删除角色时，需要找出关联角色记录的其他属性，递减引用计数。

== 自定义表单

=== 界面操作流程

. 用户进入 实体 列表
. 点击 新建 ，进入 实体新建 页
. 输入 实体编码（推荐英文，非强制，后续不可更改）
. 输入 实体名称（中文）
. 点击 添加属性，出现属性栏目
. 输入 属性编码（规则同实体编码）、属性名称
. 选择 类型，根据类型动态显示约束条件列表
. 勾选需要的约束条件（多选）
.. 勾选 必填，无需额外输入
.. 勾选 最小长度，输入最小长度值
.. 勾选 最大长度，输入最大长度值
.. 勾选 选项，输入 字典类型编码，需要事先录入字典数据
.. 勾选 最小值，输入最小值
.. 勾选 最大值，输入最大值

.类型及其关联的约束
. 文本/链接/邮箱
.. 必填
.. 最小长度
.. 最大长度
. 数值
.. 必填
.. 最小值
.. 最大值
. 是否
.. 必填
. 选项
.. 必填
. 关联
.. 必填

== 待办

* 模块拆解。clazz 不依赖 service，resolveClass 返回的 EntityAdd 需要重新定义
* 注解属于实现层面，不属于接口层面
